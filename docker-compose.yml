version: '3.8'

services:
  # ==========================================
  # FRONTEND SERVICE (React + Vite)
  # ==========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # Build-time variable for API URL
        # Override with: docker-compose build --build-arg VITE_API_BASE_URL=https://api.yoursite.com
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:5000}
    container_name: uide_frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - uide_network

  # ==========================================
  # BACKEND SERVICE (Flask + Python)
  # ==========================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: uide_backend
    ports:
      - "5000:5000"
    volumes:
      # CRITICAL: Persist SQLite database
      - ./backend/data:/app/backend/data
    environment:
      # DeepSeek API URL (Ollama service)
      - DEEPSEEK_API_URL=http://ollama:11434/api/generate
      - DATABASE_PATH=/app/backend/data/forensics.db
      - FLASK_ENV=production
      - LOG_LEVEL=INFO
    depends_on:
      - ollama
    restart: unless-stopped
    networks:
      - uide_network

  # ==========================================
  # OLLAMA SERVICE (DeepSeek-R1 LLM)
  # ==========================================
  ollama:
    image: ollama/ollama:latest
    container_name: uide_ollama
    ports:
      - "11434:11434"
    volumes:
      # Persist downloaded models
      - ollama_data:/root/.ollama
    restart: unless-stopped
    networks:
      - uide_network
    # Optional: GPU support (uncomment if you have NVIDIA GPU)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

# ==========================================
# VOLUMES
# ==========================================
volumes:
  ollama_data:
    driver: local

# ==========================================
# NETWORKS
# ==========================================
networks:
  uide_network:
    driver: bridge
